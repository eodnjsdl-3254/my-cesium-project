version: '3.8'

services:
  # 1. Nginx (게이트웨이)
  nginx:
    image: nginx:alpine
    container_name: goyang_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro      
      - ./uploads:/usr/share/nginx/html/files:ro 
    depends_on:
      - geoserver
      - converter # 컨버터도 기다림
    networks:
      - gis-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # 2. 공간 DB (PostGIS)
  db:
    image: kartoza/postgis:14-3.1
    container_name: goyang_postgis
    volumes:
      - postgis-data:/var/lib/postgresql
    environment:
      - POSTGRES_DB=gisdb
      - POSTGRES_USER=docker
      - POSTGRES_PASS=docker
      - ALLOW_IP_RANGE=0.0.0.0/0
    ports:
      - "5432:5432"
    networks:
      - gis-network
    restart: on-failure

  # 3. 맵 서버 (GeoServer)
  geoserver:
    image: kartoza/geoserver:2.22.0
    container_name: goyang_geoserver
    volumes:
      - geoserver-data:/opt/geoserver/data_dir
    environment:
      - GEOSERVER_DATA_DIR=/opt/geoserver/data_dir
      - GEOSERVER_ADMIN_PASSWORD=geoserver
      - GEOSERVER_ADMIN_USER=admin
      - CORS_ENABLED=true
      - CORS_ALLOWED_ORIGINS=*
      - GEOSERVER_CSRF_DISABLED=true
    ports:
      - "8080:8080"
    depends_on:
      - db
    networks:
      - gis-network
    restart: on-failure

  # 4. 3D 변환 서비스 (FastAPI + Blender)
  converter:
    build: ./converter   # converter 폴더의 Dockerfile 빌드
    container_name: goyang_converter
    ports:
      - "8000:8000"      # 외부에서 접근 가능하게 포트 개방
    volumes:
      # 호스트의 ./uploads 폴더를 컨테이너의 /app/files에 연결
      - ./uploads:/app/files 
    networks:
      - gis-network
    restart: always

volumes:
  postgis-data:
  geoserver-data:

networks:
  gis-network: